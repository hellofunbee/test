<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>物联网-发布信息-政策信息</title>
  <link rel="stylesheet" href="css/reset.min.css">
  <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
  <link rel="stylesheet" href="css/style.css">

</head>

<body>
  <div class="mx-main" page="publish">
    <div class="mx-handle clearfix">
      
      <div class="sm-title fl">
        政策信息
      </div>
      
      <a href="javascript:;" id="fbxx" class="fr btn btn-default mr15">发布新信息</a>

      
      <div class="mx-top-search fr">
        <input type="text">
        <a href="#">搜索</a>
      </div>
      
      <div class="mx-top-select fr">
        <h3>政策信息类型<em><i></i></em></h3>
        <dl class="mx-top-select-list publish-search-cls" require="false">
          <dd>政策信息类型2</dd>
          <dd>政策信息类型3</dd>
        </dl>
      </div>
    </div>
    <div class="message-list-area">
    
    <div class="mx-title">
      <h3>惠农政策<a href="#" class="more">了解更多&gt;</a></h3>
    </div>
    
    <div class="mt20 clearfix module-box-cnt">
      <div class="module-box">
        <div class="close"></div>
        <div class="module-info">
          <div class="img">
            <img src="images/pic2.png" alt="">
          </div>
          <h4>天知道博士</h4>
          <p>2018年7月12日</p>
        </div>
        <h3>越瓜保护地高产栽培技术</h3>
        <p class="sm-info">越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值...</p>
        <p class="tr"> <a href="#">了解更多&gt;</a> </p>
      </div>
      <div class="module-box">
        <div class="close"></div>
        <div class="module-info">
          <div class="img">
            <img src="images/pic3.png" alt="">
          </div>
          <h4>天知道博士</h4>
          <p>2018年7月12日</p>
        </div>
        <h3>人心果栽培技术</h3>
        <p class="sm-info">越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值...</p>
        <p class="tr"> <a href="#">了解更多&gt;</a> </p>
      </div>
      <div class="module-box">
        <div class="close"></div>
        <div class="module-info">
          <div class="img">
            <img src="images/pic4.png" alt="">
          </div>
          <h4>天知道博士</h4>
          <p>2018年7月12日</p>
        </div>
        <h3>茄子剪枝再生栽培技术</h3>
        <p class="sm-info">越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值...</p>
        <p class="tr"> <a href="#">了解更多&gt;</a> </p>
      </div>
      <div class="module-box">
        <div class="close"></div>
        <div class="module-info">
          <div class="img">
            <img src="images/pic5.png" alt="">
          </div>
          <h4>天知道博士</h4>
          <p>2018年7月12日</p>
        </div>
        <h3>越瓜保护地高产栽培技术是</h3>
        <p class="sm-info">越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值...</p>
        <p class="tr"> <a href="#">了解更多&gt;</a> </p>
      </div>
    </div>
    </div>


  </div>


  
  
  <div class="xxx-layer">
    <div class="clearfix">
      <div class="left-info">
        <h4>标题</h4>
        <p><input type="text" id="publish-title"></p>
        <h4>作者名</h4>
        <p><input type="text" id="publish-author"></p>
        <h4>所属一级分类</h4>
        <p><select name="" id="publish-class-sel"><option value=""></option></select></p>
      </div>
      <div class="right-file"><input type="file" id="publish-file"><img src="images/upfile.png" alt=""></div>
    </div>
    <h4>原文信息</h4>
    <p><textarea name="" id="publish-content" cols="30" rows="10"></textarea></p>
    <div class="tc mt20">
      <a href="#" class="btn-lg btn-df-gray" id="publish-frm-cancel">取消</a><a href="#" class="btn-lg btn-df-blue" id="publish-frm-save">保存</a>
    </div>
  </div>

  


  <script type="text/javascript">
      if (!window.jQuery) {
          var html =
              '<script src="js/jquery.min.js"><\/script>\n' +
              '<script src="js/jquery.scrollTo.min.js"><\/script>\n' +
              '<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n' +
              '<script src="js/jquery.ztree.all.min.js"><\/script>\n' +
              '<script src="js/layer/laydate/laydate.js"><\/script>\n' +
              '<script src="js/layer/layer.js"><\/script>\n' +
              '<script src="js/slide.js"><\/script>\n' +
              '<script src="js/common.js"><\/script>\n' +
              '<script src="js/purl.js"><\/script>\n' +
              '<script src="js/api.js"><\/script>\n' +
              '<script src="js/ui.js"><\/script>';
          document.write(html);
      }
  </script>

  <script>
      var page=$('[page="publish"]');

    page.find('.mx-top-select h3').click(function() {
      if ($(this).hasClass('on')) {
        $(this).removeClass('on');
        $(this).next('.mx-top-select-list').hide();
      } else {
        $(this).addClass('on');
        $(this).next('.mx-top-select-list').show();
      }
    });

    var listCategory=function(info){
        // info['c_name']
        // info['c_id']
        // info['c_photo']
        // info['c_type']

        var cEl=page.find('.message-list-area');//.empty();

        var tpl='<!-- 信息模块 -->\n' +
            '<div class="mx-title">\n' +
            '  <h3><span class="category_name"></span><a href="#" class="more">了解更多&gt;</a></h3>\n' +
            '</div>';

            var tplItem= //'<div class="mt20 clearfix module-box-cnt">' +
            '<div class="module-box ">' +
            '<div class="close"></div>' +
            '<div class="module-info">' +
            '<div class="img">' +
            '<img src="" class="cover" alt="" />' +
            '</div>' +
            '<h4 class="author"></h4>' +
            '<p class="date"></p>' +
            '</div>' +
            '<h3 class="title"></h3>' +
            '<p class="sm-info content"></p>' +
            '<p class="tr"> <a href="#" class="item-more">了解更多&gt;</a> </p>' +
            '</div>'
            //'</div>'
            ;
      var cateMoreA=$(tpl).appendTo(cEl)
          .find('.category_name').text(info['c_name']).end()
          .find('.more').click(function(){
          var nextEl = $(this).parents('div').next('.module-box-cnt');
              var a = nextEl.find('>.module-box:visible:last');
              nextEl.find('>.module-box').show();
              setTimeout(function(){
                  $.scrollTo(a);
              },100);
          $(this).remove();
      });
        var cBody=$('<div class="mt20 clearfix module-box-cnt"></div>');

        cBody.appendTo(cEl);
        if(info.list.length<8){
            cateMoreA.remove();
        }
        $(info.list).each(function (idx) {
            var item = $(tplItem).appendTo(cBody);
            item.find('.author').text(this['m_authorname']);
            item.find('.date').text(new Date(this['m_time'] * 1000).format("yyyy年MM月dd日"));
            item.find('.content').text(UI.cutSize(this['m_content'], 250));
            if (this['m_cover']) {
                item.find('.cover').attr('src', this['m_cover']);
            }
            item.find('a.item-more').attr('onclick',
                'showMessageDetail(' + this['m_id'] + ',' + info['c_type'] + ',' + '"查看");return false;');
            item.find('.close').attr('id',this['m_id']).click(function(e){
                e.preventDefault();
                var id=$(this).attr('id');
                layer.confirm('确定删除吗?', function (idx) {
                    API.service('/deleteMessage', {m_id: id}, function (e) {
                        layer.msg(e.msg);
                        queryIt();
                    });
                    layer.close(idx);
                });
                return false;
            });
            if (idx > 7) {
                item.hide();
            }
        });
    };
    var queryIt=function(){
        var data = {m_type:1};
        var title=page.find('.mx-top-search').find('input').val();
        if(title){
            data.m_title=title;
        }
        API.service('/listMessage1Bygroup',data,function(d){
            page.find('.message-list-area').empty();
            $(d.object).each(function(){
                var clsValue = searClsEl.attr('value');
                if (clsValue==='' || parseInt(clsValue) === parseInt(this['c_id'])) {
                    listCategory(this);
                }
            })
        })
    };
      page.find('.mx-top-search').find('a').click(function(){
          queryIt();
      });
    var searClsEl = page.find('.publish-search-cls');
    searClsEl.on('change',function(){
        $(this).val();
        queryIt();
    });
    API.service('/listClass1',{c_type:4},function(d){
        searClsEl.selectX(d);
    });

    //select 模拟
    $('#fbxx').click(function() {
      layer.open({
        type: 1,
        area: ['720px', '650px'],
        title: '发布新消息',
        content: $('.xxx-layer'),
        skin: 'mlayer'
          ,success:function(layero, index){

              var sel=layero.find('#publish-class-sel').empty();
              var authorEl=layero.find('#publish-author').val('');
              var titleEl=layero.find('#publish-title').val('');
              var contentEl=layero.find('#publish-content').val('');
              var fileEl=  layero.find('#publish-file');
              fileEl.next('img').attr('src','images/upfile.png');
              //var defaultImgSrc=fileEl.find('img').attr('src');
           fileEl.on('change',function(){
                  if($(this).val()){
                      var obj = new FormData();
                      obj.append('ckuid',sessionStorage.getItem('ckuid'))
                      obj.append('cksid',sessionStorage.getItem('cksid'))
                      obj.append('picture',fileEl.get(0).files[0])
                      obj.append('oldfile','');
                      startLoading();
                      $.ajax({
                          url: apiPre+"/addPicture",
                          type: "post",
                          enctype: 'multipart/form-data',
                          processData: false,
                          contentType: false,
                          data:obj,
                          cache: false,
                          success: function (data) {
                              stopLoading();
                              if(data.state===0){
                                  fileEl.next('img').attr('src',data.object).attr('value',data.object);
                              }else if(data.state===2){
                                  layer.alert(data.msg,function(){
                                      window.parent.location.href='./login.html'
                                  });
                              }else{
                                  layer.alert(data.msg);
                              }
                          },
                          error:function(){
                              stopLoading();
                              layer.alert( '请求失败，请重新尝试');

                          }
                      });
                  }
              });
              API.service('/listClass1',{c_type:4},function(d){
                  console.log('class ',d.object); //c_id,c_name
                $(d.object).each(function(i){
                    var d=this;
                     $("<option>"+d['c_name']+"</option>").attr('value',d['c_id']).appendTo(sel);
                    });
              });
              layero.find('#publish-frm-save,#publish-frm-cancel').click(function(e){

                  e.preventDefault();
                  var bSave=$(this).attr('id')==='publish-frm-save';
                  if(!bSave){
                      layer.close(index);
                      return;
                  }
                  if(!authorEl.val()){
                      layer.msg('请输入作者');
                      authorEl.focus();
                      return false;
                  }
                  ///addPicture
                  // form-data; name="ckuid"
                  // form-data; name="cksid",
                  // name="picture"; filename="bg0.png"
                  // form-data; name="oldfile"

                  API.service('/addMessage', {
                      m_authorname: authorEl.val(),
                      m_class:  sel.val(),
                      m_content:   contentEl.val(),
                      m_title:  titleEl.val(),
                      m_type: "1",
                      m_cover: fileEl.find('img').attr('value')
                  }, function (d) {
                      layer.msg(d.msg);
                      layer.close(index);
                      //刷新查询
                     // searClsEl.find('dl[value="'+sel.val()+'"]').click();
                      queryIt();
                  });
                  return false;
              })
          }
      })
    })
  </script>

</body>

</html>