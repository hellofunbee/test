<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>物联网-系统管理</title>
    <link rel="stylesheet" href="css/reset.min.css">
    <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="xgzsb" page="znkzgz">
    <div class="clearfix mt10">
        <div class="btn-groups fl">
            <a href="javascript:;" class="btn-lg btn-df-red btn-delete-all">删除选中规则</a>
            <a href="javascript:;" class="btn-lg btn-df-blue" id="xjgz">新建规则</a>
        </div>
        <a href="javascript:;" class="btn-lg btn-df-blue fr">保存</a></div>
    <table class="mx-table2 mt10">
        <thead>


        <tr>
            <th width="3%" class="tc">
                <div class="mx-checkbox"><em></em></div>
            </th>
            <th>规则名称</th>
            <th width="10%">间隔（分钟）</th>
            <th width="6%">状态</th>
            <th width="12%">监测传感器</th>
            <th width="8%">数值范围</th>
            <th width="8%">上升值</th>
            <th width="8%">下降值</th>
            <th width="8%">执行时长(秒)</th>
            <th width="12%">执行命令</th>
        </tr>
        </thead>
        <tbody>
        <tr class="row-tpl">
            <td class="tc" x>
                <div class="mx-checkbox"><em></em></div>
            </td>
            <td><input type="text" faild="duration" class="text"></td>
            <td><input type="text" faild="ruleEnable" class="text"></td>
            <td>
                <div class="mx-switch"><em>关</em><i></i></div>
            </td>
            <td><select name="" faild="channel" class="text">
                <option value="">温度传感器</option>
            </select></td>
            <td><input type="text" class="text"></td>
            <td><input type="text" class="text"></td>
            <td><input type="text" class="text"></td>
            <td><input type="text" class="text"></td>
            <td><select name="" class="text">
                <option value="">开启</option>
            </select>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script type="text/javascript">if (!window.jQuery) {
    var html = '<script src="js/jquery.min.js"><\/script>\n<script src="js/jquery.scrollTo.min.js"><\/script>\n<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n<script src="js/jquery.ztree.all.min.js"><\/script>\n<script src="js/layer/laydate/laydate.js"><\/script>\n<script src="js/layer/layer.js"><\/script>\n<script src="js/slide.js"><\/script>\n<script src="js/common.js"><\/script>\n<script src="js/purl.js"><\/script>\n<script src="js/api.js"><\/script>\n<script src="js/ui.js"><\/script>';
    document.write(html)
}</script>
<script>
    $(".mx-switch").click(function () {
        var t = $(this).children("em").text();
        console.log(t), "开" == t ? ($(this).removeClass("on"), $(this).children("em").text("关")) : ($(this).addClass("on"), $(this).children("em").text("开"))
    }), $(".mx-checkbox").click(function (t) {
        $(this).toggleClass("on")
    });

    var url = purl(location.href);
    var defVal = {};

    defVal.ctrl_id = url.param('ctrl_id');
    defVal.type = url.param('type');
    defVal.deviceId = url.param('deviceId');
    defVal.tp_id = url.param('tp_id');

    console.log(defVal)

    $(".tbl-list").on("click", ".mx-checkbox", function (t) {
        $(this).toggleClass("on")
    });

    var tbody = $(".tbl-list>tbody").empty();
    var thead = $(".tbl-list>thead");

    thead.find(".mx-checkbox").click(function () {
        $(this).hasClass("on") ? tbody.find(":not([field]).mx-checkbox").removeClass("on") : tbody.find(":not([field]).mx-checkbox").addClass("on")
    });

    var tpl = $("<div></div>").append($(".row-tpl").clone()).html();

    API.service("/getGatherSettings", {deviceId: defVal.deviceId, tp_id: defVal.tp_id,listDisplay:1}, function (e) {
        var t = [];
        for (var i in e.object)
            t.push('<option value="' + e.object[i].channel + '">' + e.object[i].name + "</option>");
        var select = t.join("");

        API.service(apiPre + "/listRule", {ctrl_id: defVal.ctrl_id, type: 1}, function (rsp) {
            $.each(rsp.object, function (i) {
                var item = this;
                UI.appendFieldTo(tpl, item, tbody).find('[field="channel"]').html(select).data("data", item);
            });
        });
    });


    $(".mx-checkbox").on("click", function () {
        var me = $(this);
        var onAll = me.toggleClass("on").is(".select-all");
        if (onAll) {
            var checkBox = layero.find("tbody .mx-checkbox").removeClass("on");
            if (me.is(".on")) {
                checkBox.addClass("on")
            }
        }
    });
    $(".btn-edit").on('click', function () {
        var item = $(this).parents("tr").data("data");
        layer.open({
            type: 2,
            title: "修改规则",
            area: ["800px", "600px"],
            content: "xjgz.html?action=update&r_id=" + item.r_id,
            skin: "mlayer"
        });
        return false
    });


    $(".btn-delete-all").on("click", function () {
        var checkBox = layero.find("tbody .mx-checkbox.on");
        if (!checkBox.size()) {
            layer.msg("请选择要删除的行");
            return false
        }
        layer.confirm("确定删除选择的" + checkBox.size() + "行吗？", function (idx) {
            checkBox.each(function () {
                var itemTr = $(this).parents("tr");
                var item = itemTr.data("data");
                API.service("/deleteRule", {r_id: item.r_id}, function (d) {
                    layer.msg(d.msg);
                    itemTr.fadeOut().remove()
                })
            });
            layer.close(idx)
        })
    });


    $("table.mx-table2>tbody").empty();

    $("#xjgz").click(function () {
        layer.open({
            type: 2,
            title: "新建规则",
            area: ["800px", "600px"],
            content: "xjgz-add.html?action=add&ctrl_id=" + defVal.ctrl_id + "&type=1",
            skin: "mlayer"
        });
    });


    API.service("/getGatherSettings", {deviceId: defVal.deviceId, tp_id: defVal.tp_id,listDisplay:1}, function (e) {
        var t = [];
        for (var i in e.object)
            t.push('<option value="' + e.object[i].channel + '">' + e.object[i].name + "</option>");
        var select = t.join("");


        getNewValueFromHtml = function (t) {


            var a = {ala_state: t.find('.mx-switch').hasClass('on') ? 1 : 0};

            return t.find("[field]").each(function () {
                var t = $(this);
                e = t.attr("field");
                t.is(".mx-checkbox") ? a[e] = t.hasClass("on") ? 1 : 0 : (t.is("input") || t.is("select") || t.is("textarea")) && (a[e] = t.val())


            }), a
        };
        addRow = function (t, e) {
            t || (t = {});
            var a = UI.appendFieldTo(tpl, t, tbody).data("data", t);

            var ala_state = t.ala_state;
            if (ala_state == 1) {
                a.find(".mx-switch").addClass('on');
            } else {
                a.find(".mx-switch").removeClass('on');
            }


            !0 === e && setTimeout(function () {
                $.scrollTo(a), a.find("input:eq(0)").focus()
            }, 100);


            $(".mx-switch").on("click", function (t) {
                if ($(this).hasClass('on')) {
                    $(this).removeClass('on');
                } else {
                    $(this).addClass('on');
                }
            });

        };
        load = function () {
            tbody.empty();
            API.service("/listAlarmRule", {
                param: {deviceid: defVal.deviceId},
                tp_id: defVal.tp_id
            }, function (t) {
                console.log(t)
                $(t.object).each(function () {
                    addRow(this)
                })
            })
        };
        $(".btn-add").click(function () {
            addRow({}, !0)
        });
        top.clibData = top.clibData || [];
        var updateClibDataStatus = function () {
            top.clibData.length ? $(".btn-paste").text("粘贴(" + top.clibData.length + ")") : $(".btn-paste").text("粘贴")
        };
        updateClibDataStatus();

        $(".btn-save").click(function () {
            var n = [];
            tbody.find("tr").each(function () {

                var t = $(this);

                var e = t.data("data");
                var a = getNewValueFromHtml(t);

                if (!a)
                    return !(c = !1);
                a.deviceid = defVal.deviceId;
                var i = $.extend({}, e, a);
                n.push(i)
            });

            if (!n)
                return false;

            API.service("/addAlarmRuleList", {deviceid: defVal.deviceId, aList: n}, function (t) {
                layer.msg("保存成功！"), UI.closeIframeDialog() || load()
            });
        });
        $(".btn-delete").click(function () {
            var t = tbody.find(".mx-checkbox.on:not([field])");
            t.size() ? t.each(function (t) {
                $(this).parents("tr").fadeOut(function () {
                    $(this).remove()
                }), layer.msg("删除完成!")
            }) : layer.msg("请选择要删除的行!")
        });
        load();


    })


</script>
</body>
</html>