<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>物联网-发布信息-即时信息</title>
  <link rel="stylesheet" href="css/reset.min.css">
  <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
  <link rel="stylesheet" href="css/style.css">

</head>

<body>
  <div class="mx-main" page="publish2">
    <div class="mx-handle clearfix">
      
      <div class="sm-title fl">
        即时信息
      </div>
      
      <a href="javascript:;" id="fbxx" class="fr btn btn-default mr15">发布新信息</a>

      
      <div class="mx-top-search fr">
        <input type="text">
        <a href="#">搜索</a>
      </div>
      
      <div class="mx-top-select fr">
        <h3>即时信息类型<em><i></i></em></h3>
        <dl class="mx-top-select-list publish2-search-cls" require="false">
          <dd>即时信息类型2</dd>
          <dd>即时信息类型3</dd>
        </dl>
      </div>
    </div>
    
    <div class="xxfb-module clearfix newslist">
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>

      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>
      <div class="xx-list">
        <div class="time">
          <div class="close"></div>
          <h3>2018年</h3>
          <p>7月24日</p>
        </div>
        <div class="info">
          <h3>生猪屠宰价格信息</h3>
          <p>据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...
          </p>
        </div>
      </div>


    </div>
    


  </div>


  
  
  <div class="xxx-layer">
    <div class="clearfix">
      <div class="fl" style="width:380px;">
        <h4>标题</h4>
        <p><input type="text" id="publish2-title"></p>
      </div>
      <div class="fr" style="width:200px;">
        <h4>所属一级分类</h4>
        <p><select name="" id="publish2-class-sel"><option value=""></option></select></p>
      </div>
    </div>
    <h4>原文信息</h4>
    <p><textarea name="" id="publish2-content" cols="30" rows="10"></textarea></p>
    <div class="tc mt20">
      <a href="#" class="btn-lg btn-df-gray" id="publish2-frm-cancel">取消</a><a href="#" class="btn-lg btn-df-blue" id="publish2-frm-save">保存并发送</a>
    </div>
  </div>

  

  <script type="text/javascript">
      if (!window.jQuery) {
          var html =
              '<script src="js/jquery.min.js"><\/script>\n' +
              '<script src="js/jquery.scrollTo.min.js"><\/script>\n' +
              '<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n' +
              '<script src="js/jquery.ztree.all.min.js"><\/script>\n' +
              '<script src="js/layer/laydate/laydate.js"><\/script>\n' +
              '<script src="js/layer/layer.js"><\/script>\n' +
              '<script src="js/slide.js"><\/script>\n' +
              '<script src="js/common.js"><\/script>\n' +
              '<script src="js/purl.js"><\/script>\n' +
              '<script src="js/api.js"><\/script>\n' +
              '<script src="js/ui.js"><\/script>';
          document.write(html);
      }
  </script>

  <script>
    $('.mx-top-select h3').click(function() {
      if ($(this).hasClass('on')) {
        $(this).removeClass('on');
        $(this).next('.mx-top-select-list').hide();
      } else {
        $(this).addClass('on');
        $(this).next('.mx-top-select-list').show();
      }
    });
    var page=$('[page="publish2"]');
    var searchBarEl=page.find('.mx-top-search');
    var searClsEl = page.find('.publish2-search-cls');

    //即时信息
    var queryIt = function () {
        var param = {m_type: 2};
        if(searClsEl.attr('value')!==''){
            param.m_class=searClsEl.attr('value');
        }
        if(searchBarEl.find('input').val()){
            param.m_title=searchBarEl.find('input').val();
        }
        var list = page.find('.newslist').empty();
        API.service('/listMessage',param, function (d) {
            var dataArray = d.object;
            var tpl = '<div class="time">' +
                '  <div class="close"></div>' +
                '  <h3>{year}年</h3>' +
                '  <p>{monthDay}</p>' +
                '</div>' +
                '<div class="info">' +
                '  <h3 class="news_title">生猪屠宰价格信息</h3>' +
                '  <p class="news_content">据农业部监测，上周（8月14日-8月20日）全国规模 以上生猪定点屠宰企业生猪平均收购价格为15.03...' +
                '  </p>' +
                '</div>';
            $(dataArray).each(function (i) {
                var d = this;
                var li = $('<div class="xx-list"></div>').appendTo(list);
                var date = new Date(d['m_time'] * 1000);//unit time
                li.append(tpl
                    .replace(/{year}/g, date.format('yyyy'))
                    .replace(/{monthDay}/g, date.format('MM月dd日')))
                    .find('.news_title').text(d['m_title']).end()
                    .find('.news_content')
                    .text(UI.cutSize(d['m_content'], 36))
                    .end()
                    .find('.news_title')
                    .attr('m_id', d['m_id'])
                    .click(function () {
                        showMessageDetail($(this).attr('m_id'));
                        return false;
                    }).end().find('.close')
                    .attr('m_id', d['m_id'])
                    .attr('m_title', d['m_title'])
                    .click(function () {
                        var me = $(this);
                        var title = me.attr('m_title');
                        layer.confirm('确定删除[' + title + ']吗？', function (idx) {
                            layer.close(idx);
                            API.service('/deleteMessage', {m_id: me.attr('m_id')}, function (e) {
                                layer.msg(e.msg);
                                queryIt();
                            })
                        });
                    })
            });
        },function(e){
            layer.msg(e.msg);
        })
    }
    //select 模拟
    $('#fbxx').click(function() {
        layer.open({
            type: 1,
            area: ['720px', '500px'],
            title: '新建即时消息',
            content: $('.xxx-layer'),
            skin: 'mlayer',success:function(layero,index){
                var sel=layero.find('#publish2-class-sel').empty();
                var titleEl=layero.find('#publish2-title').val('');
                var contentEl=layero.find('#publish2-content').val('');

                API.service('/listClass1',{c_type:5},function(d){
                    $(d.object).each(function(i){
                        var d=this;
                        $("<option>"+d['c_name']+"</option>").attr('value',d['c_id']).appendTo(sel);
                    })
                });


                layero.find('#publish2-frm-save,#publish2-frm-cancel').click(function(e){
                    e.preventDefault();
                    var bSave=$(this).attr('id')==='publish2-frm-save';
                    if(!bSave){
                        layer.close(index);
                        return;
                    }

                    API.service('/addMessage', {
                        m_class:  sel.val(),
                        m_content:   contentEl.val(),
                        m_title:  titleEl.val(),
                        m_type: "2",//消息
                    }, function (d) {
                        layer.msg(d.msg);
                        layer.close(index);
                        //刷新查询
                        // searClsEl.find('dl[value="'+sel.val()+'"]').click();
                        queryIt();
                    });
                    return false;
                })
            }
        })
    })

    searClsEl.on('change',function(){
        $(this).val();
        queryIt();
    });
    searchBarEl.find('a').click(function(){
        queryIt();
    });

    //5 通知分类
    API.service('/listClass1',{c_type:5},function(d){
        searClsEl.selectX(d);
    });
  </script>

</body>

</html>