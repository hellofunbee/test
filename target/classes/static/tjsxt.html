<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>物联网-系统管理</title>
  <link rel="stylesheet" href="css/reset.min.css">
  <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
  <link rel="stylesheet" href="css/style.css">

</head>

<body>
  <div class="tjzsb">
    <form id="formId">
    <table class="">
      <tr>
        <th>在线状态</th>
        <td field="s_online" render="dict" dict="ipc_online">-</td>
      </tr>
      <tr>
        <th>IPC设备编号</th>
        <td field="mapingDeviceId">-</td>
      </tr>
      <tr>
        <th>设备名称</th>
        <td><input type="text" field="tp_name" class="text-blue"></td>
      </tr>
      <tr>
        <th>IPC设备地址</th>
        <td><input type="text" class="text-blue-sm" field="s_ip">:<input type="text" field="s_port" class="text-blue-mm"></td>
      </tr>
      <tr>
        <th>设备用户名</th>
        <td><input type="text" field="s_username" class="text-blue"></td>
      </tr>
      <tr>
        <th>设备密码</th>
        <td><input type="text" field="s_password" class="text-blue"></td>
      </tr>
    </table>
    </form>
    <div class="tc mt20">
      <a href="javascript:;" class="btn-lg btn-df-red btn-reset">重置</a>
      <a href="javascript:;" class="btn-lg btn-df-blue btn-save">保存</a>
    </div>

    <script type="text/javascript">
        if (!window.jQuery) {
            var html =
                '<script src="js/jquery.min.js"><\/script>\n' +
                '<script src="js/jquery.scrollTo.min.js"><\/script>\n' +
                '<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n' +
                '<script src="js/jquery.ztree.all.min.js"><\/script>\n' +
                '<script src="js/layer/laydate/laydate.js"><\/script>\n' +
                '<script src="js/layer/layer.js"><\/script>\n' +
                '<script src="js/slide.js"><\/script>\n' +
                '<script src="js/common.js"><\/script>\n' +
                '<script src="js/purl.js"><\/script>\n' +
                '<script src="js/api.js"><\/script>\n' +
                '<script src="js/ui.js"><\/script>';
            document.write(html);
        }
    </script>
    <script>
        //add
        var obj = {
            "deviceId": "",
            "pointEntity": {"tp_pid": "", "ip": "", "port": "", "tp_name": ""},
            "s_nod": 12,
            "s_ip": "",
            "s_port": "",
            "s_username": "",
            "s_password": "",
            "s_stream": "1",
            "s_power": "2",
            // "mapingDeviceId": "10.00.21.32.13",
            "ipc": {"s_pwr": "0", "s_pwrval": "0", "deviceId": ""}
        };
        var editMapperFields={
            "s_ip":"s_host",
            "s_port":"s_hostport",
            "s_username":"username",
            "s_password":"password",
            "tp_name":"name"
        };
        var url = purl(location.href);
        var deviceId  = url.param('deviceId');
        obj.deviceId= deviceId ;
        obj.pointEntity.port=url.param('port');
        obj.pointEntity.ip=url.param('ip');
        obj.pointEntity.tp_pid=url.param('tp_id');
        var tpName=url.param('name');
        var maxNo=parseInt(url.param('max_nod'));
        var action=url.param('action');
        var updateObj={};
        var load=function(){
            // alert(location.href);
            //s_online|1在线|0不在线
            ///getIPCProxy
            //,"pointEntity":{},"ipc":{"deviceId":"10.00.21.15.01","type":1},"id":"45"}
            //{"success":true,"msg":"查看成功","object":{"id":10.0,"mapingDeviceId":"10.00.21.15.01",
            // "deviceId":"10.00.21.15","s_host":"192.168.0.159","s_hostport":"80","s_proxy":"9008",
            // "s_pwr":"1","s_pwrval":"1","username":"admin","password":"vr123456"
            // ,"s_stream":"0","s_online":"1","name":"11号大棚多媒体","tp_name":"11号大棚多媒体",
            // "s_nod":"0","s_power":"1","ipcid":45.0},"state":0}
            var id=url.param("id");
            var type=url.param("type")||1;
            // API.service('/listIPC',

            API.service('/getIPCProxy',
                { pointEntity:{},ipc:{ deviceId:deviceId,type:type},id:id },function(d){
                console.log(d.object);
                updateObj=d.object;
                $('[field]').each(function () {
                    var el = $(this);
                    var fieldName = el.attr('field');
                    var val = d.object[fieldName];
                    if (editMapperFields[fieldName]) {
                        val = d.object[editMapperFields[fieldName]];
                    }
                    if (el.is('input')) {
                        el.val(val);
                    } else {
                        if (el.attr('render') && el.attr('dict')) {
                            el.text(API.dict[el.attr('dict')][val] || '');
                        } else {
                            el.text(val);
                        }
                    }
                });
            })
        };
        if(action==='update'){
            load();
        }
        obj.ipc.deviceId= obj.deviceId;
        obj.s_nod=maxNo;

        var frm=$('#formId');
        $('a.btn-reset').click(function(){
            if(action==='update'){
             load();
            }else{
            frm.get(0).reset();
            }
        });
        var doUpdate=function(obj){
//{"ckuid":"1","cksid":"d20a80e9-b022-4bbc-9a76-3de5bbfae623","pointEntity":{"tp_name":"11号大棚多媒体"},"ipc":
// {"deviceId":"10.00.21.15.01","s_host":"192.168.0.159","s_hostport":"80","id":"10","type":1,"username":"admin",
// "password":"vr123456"},"id":"45","s_stream":"0","s_power":"1"}



            // "pointEntity":{"tp_pid":"1","ip":"192.168.0.168","port":"52390"},
            // "s_nod":"1",
            //     "s_ip":"192.168.0.232",
            //     "s_port":"80",
            //     "s_username":"admin",
            //     "s_password":"12345",
            //     "ipc":{"s_pwr":"0","s_pwrval":"1","deviceId":"10.00.21.74"},
            // "id":"31" //多了一个id
            //
            var newVal = {};
            for (var n in obj) {
                if (editMapperFields[n]) {
                    newVal[editMapperFields[n]] = obj[n];
                } else {
                    newVal[n] = obj[n];
                }
            }
            newVal = $.extend({}, updateObj, newVal);
            var param={
                pointEntity:newVal.pointEntity
                , "s_nod":newVal.s_nod,
                    "s_ip":newVal.s_host,
                    "s_port":newVal.s_hostport,
                    "s_username":newVal.username,
                    "s_password":newVal.password,
                    "ipc":{"s_pwr":newVal.s_pwr,"s_pwrval":newVal.s_pwrval,"deviceId":newVal.deviceId},
                "id":updateObj.id
            };

            // console.log('exampe ...',{"pointEntity":{"tp_name":"14号大棚多媒体"},
            //     "ipc":{"deviceId":"10.00.21.27.01","s_host":"192.168.0.167","s_hostport":"80","id":"2",
            //         "type":1,"username":"admin","password":"vr123456"}
            //         ,"id":"12","s_stream":"0","s_power":"1"});
            // if(true){
            //     reutrn;
            // }
            API.service('/updateIPC', param, function (rsp) {
                layer.alert(rsp.msg);
            });
        };
        $('a.btn-save').click(function () {
            //var obj={ };
            $('[field]').each(function () {
                obj[$(this).attr('field')] = $(this).val();
            });
            obj.pointEntity.tp_name = obj['tp_name'];
            if (action === 'update') {
                doUpdate(obj);
            } else { //add
                obj.s_nod++;
                API.service('/addIPC', obj, function (rsp) {
                    layer.alert(rsp.msg);
                });
            }
        });

    </script>
  </div>


</body>

</html>