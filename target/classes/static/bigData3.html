<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>物联网-大数据分析-市场数据</title>
    <link rel="stylesheet" href="css/reset.min.css">
    <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="mx-main">
    <div class="mx-handle clearfix">
        <div class="sm-title fl">生产数据</div>
        <ul class="little-menu cleafix fl">
            <li class="on"><a href="javascript:;" index="1" data-href="#kzfx">控制分析</a></li>
            <li><a href="javascript:;" index="2" data-href="#kzfx">投入品分析</a></li>
            <li class="last"><a href="javascript:;" index="3" data-href="#kzfx">生产分析</a></li>
        </ul>
    </div>
    <div class="scsj-module">
        <div id="kzfx">
            <div class="ssfx-module clearfix">
                <div class="fl">
                    <div class="fieldset">
                        <div class="legend orange">请选择要分析的设备</div>
                        <div class="fieldset-con" style="height:320px;overflow-y:auto">
                            <ul id="tree-id" class="ztree"></ul>
                        </div>
                    </div>
                    <div class="form-list mt20"><label>日期范围</label>
                        <div class="list-block"><input type="text" placeholder="2018-01-11"
                                                       id="big_data_analysis_device_from" class="text"
                                                       style="width:47%"> <span style="width:6%">-</span> <input
                                type="text" placeholder="2018-05-11" id="big_data_analysis_device_to" class="text"
                                style="width:47%"></div>
                    </div>
                </div>
                <div class="fr factor">
                    <div class="fieldset">
                        <div class="legend orange">请选择要分析的投入品</div>
                        <div class="fieldset-con" id="channels" style="height:320px;overflow-y:auto">
                            <div id="info"
                                 style="z-index: 1;position:absolute; height:300px; overflow-y:auto; ">
                                <ul id="ztree" class="ztree">
                                </ul>
                            </div>


                            <!--<div id="tpl" class="mx-checkbox mt5" value="mainLi1" data-dan="单位(%)"><em></em>
                                <label for="">电池电量</label>
                            </div>
                            <div class="mx-checkbox mt5" value="mainLi2" data-dan="单位(ppm)"><em></em><label
                                    for="">二氧化碳</label></div>
                            <div class="mx-checkbox mt5" value="mainLi3"><em></em><label for="">风向</label></div>
                            <div class="mx-checkbox mt5" value="mainLi4" data-dan="单位(%)"><em></em><label
                                    for="">土壤水分</label></div>
                            <div class="mx-checkbox mt5" value="mainLi5" data-dan="单位(v)"><em></em><label
                                    for="">系统5V电压</label></div>
                            <div class="mx-checkbox mt5" value="mainLi6" data-dan="单位(ml)"><em></em><label
                                    for="">降水量</label></div>
                            <div class="mx-checkbox mt5" value="mainLi7" data-dan="单位(℃)"><em></em><label
                                    for="">空气温度</label></div>
                            <div class="mx-checkbox mt5" value="mainLi8" data-dan="单位(lux)"><em></em><label
                                    for="">光照度</label></div>
                            <div class="mx-checkbox mt5" value="mainLi9" data-dan="单位(℃)"><em></em><label
                                    for="">土壤温度</label></div>
                            <div class="mx-checkbox mt5" value="mainLi10" data-dan="单位(%)"><em></em><label
                                    for="">空气湿度</label></div>-->
                        </div>
                    </div>
                </div>
            </div>
            <div class="tc mt20"><a href="bigData-fxjg2.html" id="big_data_analysis_simple" target="_parent"
                                    class="btn-lg btn-lg-blue">分析</a>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">if (!window.jQuery) {
    var html = '<script src="js/jquery.min.js"><\/script>\n<script src="js/jquery.scrollTo.min.js"><\/script>\n<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n<script src="js/jquery.ztree.all.min.js"><\/script>\n<script src="js/layer/laydate/laydate.js"><\/script>\n<script src="js/layer/layer.js"><\/script>\n<script src="js/slide.js"><\/script>\n<script src="js/common.js"><\/script>\n<script src="js/purl.js"><\/script>\n<script src="js/api.js"><\/script>\n<script src="js/ui.js"><\/script>';
    document.write(html)
}
</script>
<script>

    $(".scsj-module>div:not(:first)").hide(), $(".little-menu li").click(function () {
    $(this).addClass("on").siblings().removeClass("on");
    var i = $(this).children("a").attr("data-href");
    $(i).show().siblings().hide()
})</script>
<script>
    $(function () {

        var href = $("div#main_iframe").attr("src") || location.href;
        var url = purl(href);
       var tab = url.param("tab");

        var reset = function (index) {
            var c_tab = index;
            var layero = $('.mx-main');
            var lastSelectNode,
                    treeEl = $("#tree-id"),
                    onNodeSelect = function (e) {

                        var node = e;
                        if (node && lastSelectNode && lastSelectNode === node)return;
                        if (!node)node = lastSelectNode;
                        if (!node)return;

                        //当点击父节点时，自动选择第一个设备
                        if (node.oriData["tp_type"] < 3) {
                            while (node && node.oriData["tp_type"] < 3) {
                                var c = node.children;
                                if (c && c.length > 0) {
                                    node = c[0];
                                    if (node && node.oriData["tp_type"] === 3) {
                                        treeEl.data("z-tree").selectNode(node);
                                        onNodeSelect(node);
                                        return
                                    }
                                } else {
                                    layer.msg('请选择设备');
                                    treeEl.data("z-tree").selectNode(lastSelectNode);
                                    return;
                                }
                            }
                        }
//                    treeEl.data("z-tree").checkNode(node,true,true);
                        lastSelectNode = node;
//                    setChannels();
                    };
            var zTreeOnCheck = function (o) {


                var e = $("#tree-id").data("z-tree").getCheckedNodes(!0);
                if (0 === e.length)
                    return;
                var i = [];
                $.each(e, function () {
                    3 === this.oriData.tp_type && i.push(this.oriData.deviceId)
                })
                if (0 === i.length)
                    return;


            }
            setChannels();
            function setChannels() {
                if (c_tab == 3) {
                    $('.factor').hide();
                }
                if (c_tab == 2) {
                    $('.factor').show();
                    var treeEl = layero.find("#ztree");
                    var stopFunc = function (e) {
                        e.stopPropagation ? e.stopPropagation() : e.cancelBubble = true;
                    }
                    var changeName = function (node) {


                    }


                    layero.find('#info').click(function (e) {
                        e = e || event;
                        stopFunc(e);
                    });


                    var lastSelectNode;
                    /*ztree*/
                    var zTreeOnCheck = function (o) {


                        var e = $(treeEl).data("z-tree").getCheckedNodes(!0);
                        if (0 === e.length)
                            return;
                        var cids = [];
                        $.each(e, function () {
                            2 === this.oriData.c_lev && cids.push(this.oriData.c_id)
                        })
                        if (0 === cids.length)
                            return;


                    }
                    var onNodeSelect = function (node) {
                        if (node && lastSelectNode && lastSelectNode === node)return;

                        if (!node)node = lastSelectNode;

                        if (!node)return;

                        //当点击父节点时，自动选择第一个设备
                        if (node.oriData["c_lev"] < 2) {
                            while (node && node.oriData["c_lev"] < 2) {

                                var c = node.children;
                                if (c && c.length > 0) {
                                    node = c[0];
                                    if (node && node.oriData["c_lev"] === 2) {
                                        treeEl.data("z-tree").selectNode(node);
                                        onNodeSelect(node);
                                        return
                                    } else {

                                    }
                                } else {
                                    return;
                                }
                            }
                        }

                        lastSelectNode = node;
                        changeName(node);
                    };
                    treeEl.on("z-tree-load", function () {
                        var nodes = $(this).data("z-tree").getNodes();
                        nodes && nodes.length > 0 && onNodeSelect(nodes[0]);
                    });
                    UI.renderInputType(treeEl, onNodeSelect, {
                        check: {enable: !0},
                        callback: {
                            onCheck: zTreeOnCheck
                        }
                    });

                }

            }

            UI.renderPointTree("#tree-id",
                    onNodeSelect,
                    {
                        check: {enable: !0},
                        callback: {
                            onCheck: zTreeOnCheck
                        }
                    }, {
                        1: !0,
                        2: !0,
                        3: !0
                    });

            treeEl.on("z-tree-load", function () {
                var nodes = $(this).data("z-tree").getNodes();
                nodes && nodes.length > 0 && onNodeSelect(nodes[0]);
            });

            var n = $("#big_data_analysis_device_from"),
                    r = $("#big_data_analysis_device_to");
            laydate.render({elem: "#big_data_analysis_device_to"});
            laydate.render({elem: "#big_data_analysis_device_from"});

            var get_channels = function () {
                var e = $("#ztree").data("z-tree").getCheckedNodes(!0);
                if (0 === e.length) {
                    return null;
                }
                var arr = [];
                $.each(e, function () {
                    2 === this.oriData.c_lev && arr.push(this.oriData.c_id)
                });
                if (0 === arr.length) {
                    return null;
                }

                return arr;
            }

            var get_devs = function () {
                var e = $("#tree-id").data("z-tree").getCheckedNodes(!0);
                if (0 === e.length) {
                    return null;
                }
                var arr = [];
                $.each(e, function () {
                    3 === this.oriData.tp_type && arr.push(this.oriData.tp_id)
                });
                if (0 === arr.length) {
                    return null;
                }

                return arr;
            }

            $("#big_data_analysis_simple").click(function () {
                //生产分析
                if (c_tab == 3) {
                    var deviceList = get_devs();
                    if (!deviceList || deviceList.length == 0) {
                        layer.msg("请先选择要分析的设备!");
                        return false;
                    }

                    var data = {};
                    data.tp_ids = deviceList;
                    data.beginTime = n.val();
                    data.endTime = r.val();

                    if (10 !== data.beginTime.length || 10 !== data.endTime.length)
                        return layer.msg("请先选择日期范围!"), !1;
                    var t = $(this).attr("href") + "?reportParams=" + JSON.stringify(data);
                    showMainContent(t)

                    return !1
                }
               //投入品分析
                if (c_tab == 2) {

                    var deviceList = get_devs();
                    var channelList = get_channels();
                    if (!deviceList || deviceList.length == 0) {
                        layer.msg("请先选择要分析的设备!");
                        return false;
                    }
                    if (!channelList || channelList.length == 0) {
                        layer.msg("请先选择要分析的投入品!");
                        return false;
                    }
                    var data = {};
                    data.tp_ids = deviceList;
                    data.c_ids = channelList;

                    data.beginTime = n.val();
                    data.endTime = r.val();

                    if (10 !== data.beginTime.length || 10 !== data.endTime.length)
                        return layer.msg("请先选择日期范围!"), !1;
                    var t = $(this).attr("href") + "?reportParams=" + JSON.stringify(data);
                    showMainContent(t)

                    return !1
                }

                if (c_tab == 3) {


                }
            }),
                    $(".sjjc-module>div:not(:first)").hide(),
                    $(".little-menu li").click(function () {
                        $(this).addClass("on").siblings().removeClass("on");
                        var e = $(this).children("a").attr("data-href");
                        $(e).show().siblings().hide()
                    }),
                    $(".mx-checkbox").click(function (e) {
                        $(this).toggleClass("on")
                    })
        };

        $('.little-menu a').click(function () {

            var index = parseInt($(this).attr('index'));
            var url = 'bigData-input' + index + '.html';
            $('#big_data_analysis_simple').attr('href', url);

            console.log(index)
            reset(index);

        });

        if(tab){

            if(tab == 1){
                $("[index=1]").click()
            }
            if(tab == 2){
                $("[index=2]").click()
            }
            if(tab == 3){
                $("[index=3]").click()
            }
        }
        reset(1);


    });

</script>
</body>
</html>