<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>物联网-发布信息-首页资讯</title>
    <link rel="stylesheet" href="css/reset.min.css">
    <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="mx-main" page="publish4">
    <div class="mx-handle clearfix">
        <div class="sm-title fl">首页资讯</div>
        <div class="mx-top-search fl" style="margin-left:35px">
            <input type="text" id="seach-text">
            <a id="top-seacher" href="#">搜索</a>
        </div>
        <div class="sblb fr"><h3>更多</h3>
            <div class="more-cnt">
                <h4>所属一级分类</h4>
                <p>
                    <select name="" id="class1">
                        <option value=""></option>
                    </select>
                </p>
                <h4>所属二级分类</h4>
                <p>
                    <select name="" id="class2">
                        <option value=""></option>
                    </select>
                </p>

                <!-- <div class="mx-top-select" style="margin:15px auto 0;z-index:2">
                     <h3>首页资讯一级分类<em><i></i></em></h3>
                     <dl id="class1" class="mx-top-select-list ">
                         <dd>首页资讯一级分类2</dd>
                         <dd>首页资讯一级分类3</dd>
                     </dl>
                 </div>
                 <div class="mx-top-select" style="margin:15px auto;z-index:1">
                     <h3>首页资讯二级分类<em><i></i></em></h3>
                     <dl id="class2" class="mx-top-select-list">
                         <dd>首页资讯二级分类2</dd>
                         <dd>首页资讯二级分类3</dd>
                     </dl>
                 </div>-->
                <div class="mt20 tc"><a href="#" id="class-seach" class="btn-lg">搜索</a></div>
            </div>
        </div>
        <a href="javascript:;" id="syzx" class="fr btn btn-default mr15">发布新信息</a></div>

    <!--资讯-->
    <div id="articals"></div>

    <!--<div class="line-tit">新技术研究</div>
    <div class="mx-title"><h3>蔬菜<a href="#" class="more">了解更多&gt;</a></h3></div>
    <div class="mt20 clearfix module-box-cnt">
        <div class="module-box">
            <div class="module-info">
                <div class="img"><img src="images/pic2.png" alt=""></div>
                <h4>天知道博士</h4>
                <p>2018年7月12日</p></div>
            <h3>越瓜保护地高产栽培技术</h3>
            <p class="sm-info">
                越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值，含有人体所需的糖类、维生素C、维生素B1、维生素B2、钙、磷...</p>
            <p class="tr"><a href="#">了解更多&gt;</a></p></div>
        <div class="module-box">
            <div class="module-info">
                <div class="img"><img src="images/pic3.png" alt=""></div>
                <h4>天知道博士</h4>
                <p>2018年7月12日</p></div>
            <h3>人心果栽培技术</h3>
            <p class="sm-info">
                越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值，含有人体所需的糖类、维生素C、维生素B1、维生素B2、钙、磷...</p>
            <p class="tr"><a href="#">了解更多&gt;</a></p></div>
        <div class="module-box">
            <div class="module-info">
                <div class="img"><img src="images/pic4.png" alt=""></div>
                <h4>天知道博士</h4>
                <p>2018年7月12日</p></div>
            <h3>茄子剪枝再生栽培技术</h3>
            <p class="sm-info">
                越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值，含有人体所需的糖类、维生素C、维生素B1、维生素B2、钙、磷...</p>
            <p class="tr"><a href="#">了解更多&gt;</a></p></div>
        <div class="module-box">
            <div class="module-info">
                <div class="img"><img src="images/pic5.png" alt=""></div>
                <h4>天知道博士</h4>
                <p>2018年7月12日</p></div>
            <h3>越瓜保护地高产栽培技术是</h3>
            <p class="sm-info">
                越瓜又叫菴瓜、生瓜、梢瓜、酥瓜。为葫芦科，甜瓜属，甜瓜种中以嫩果生食的变种，一年生蔓性草本植物，主要分布于中国、日本及东南亚。中国栽培较普遍。越瓜具有很高的营养价值和药用价值，含有人体所需的糖类、维生素C、维生素B1、维生素B2、钙、磷...</p>
            <p class="tr"><a href="#">了解更多&gt;</a></p></div>
    </div>-->
    <div class="xxx-layer"></div>
</div>

<script type="text/javascript">
    if (!window.jQuery) {
        var html = '<script src="js/jquery.min.js"><\/script>\n<script src="js/jquery.scrollTo.min.js"><\/script>\n<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n<script src="js/jquery.ztree.all.min.js"><\/script>\n<script src="js/layer/laydate/laydate.js"><\/script>\n<script src="js/layer/layer.js"><\/script>\n<script src="js/slide.js"><\/script>\n<script src="js/common.js"><\/script>\n<script src="js/purl.js"><\/script>\n<script src="js/api.js"><\/script>\n<script src="js/ui.js"><\/script>';
        document.write(html)
    }</script>
<script src="js/ajaxfileupload.js"></script>

<script>
    var layer_html = ''+
            '        <div class="left-info">'+
            '            <h4>标题</h4>'+
            '            <p><input type="text" id="publish-title"></p>'+
            '            <h4>作者名</h4>'+
            '            <p><input type="text" id="publish-author"></p>'+
            '            <h4>所属一级分类</h4>'+
            '            <p>'+
            '                <select name="" id="publish-class-sel">'+
            '                    <option value=""></option>'+
            '                </select>'+
            '            </p>'+
            '            <h4>所属二级分类</h4>'+
            '            <p>'+
            '                <select name="" id="publish-class-sel2">'+
            '                    <option value=""></option>'+
            '                </select>'+
            '            </p>'+
            '        </div>'+
            '        <div class="right-file">'+
            '            <input type="file" name="picture" accept="image/*" id="publish-file">'+
            '            <img style="width: 100%" id="cms-cover" src="images/upfile.png" alt="">'+
            '        </div>'+
            '    </div>'+
            '    <h4>文章信息</h4>'+
            '    <p><textarea name="" id="publish-content" cols="30" rows="10"></textarea></p>'+
            '    <div class="tc mt20">'+
            '        <a href="#" id="publish-frm-cancel" class="btn-lg btn-df-gray">取消</a>'+
            '        <a href="#" id="publish-frm-save" class="btn-lg btn-df-blue">保存</a>'+
            '    </div>';

    var tplNewIt =
            '<div class="module-box">' +
            '<div class="module-info">' +
            '<div class="img">' +
            '<img src="images/pic2.png" onerror="this.setAttribute(\'url\',\'images/pic2.png\');this.removeAttribute(\'onerror\')" field="m_cover" alt="" />' +
            '</div>' +
            '<h4 field="m_authorname">天知道博士</h4>' +
            '<p field="m_time" date-format="yyyy年MM月dd日">2018年7月12日</p>' +
            '</div>' +
            '<h3 field="m_title"></h3>' +
            '<p field="m_content" max-length="100" class="sm-info">..</p>' +
            '<p class="tr">' +
            '<a href="#" onclick="showMessageDetail({m_id},4,\'查看\');return false;">了解更多&gt;</a>' +
            '</p>' +
            '</div>';
    var title1 = '<div class="line-tit">{c_name}</div> ';

    var title2 =
            '  <div class="mx-title"> ' +
            '   <h3>{c_name} ' +
            '     <a href="#" class="more" onclick="window.openPageContent(&quot;信息发布&quot;,&quot;首页资讯&quot;)">了解更多&gt;' +
            '     </a> ' +
            '   </h3> ' +
            '  </div>';
    var cnt = '<div id="cnt_{c_id}" class=" mt20 clearfix module-box-cnt xjgyjList"></div>';


    $(function () {

        var e = $('[page="publish4"]'),
                t = e.find(".mx-top-search"),
                i = e.parents("div#main_iframe").attr("src") || location.href, n = purl(i).param("keyword");
        n && t.find("input").val(n),
                queryIt = function (m_class, m_class2) {
                    var i = t.find("input").val();
                    var data = {m_type: 4, m_title: i, m_class: m_class, m_class2: m_class2};
                    API.service("/listHomePageMessage", data, function (d) {
                        console.log(d)
                        var el = $('#articals');
                        el.empty();
                        for (class1 in  d.object) {
                            var c1 = d.object[class1];
                            UI.appendFieldTo(title1, c1, el);
                            for (var class2 in c1.classList) {
                                var c2 = c1.classList[class2];
                                UI.appendFieldTo(title2, c2, el)
                                var cnt_el = UI.appendFieldTo(cnt, c2, el);

                                for (var message in c2.messageList) {
                                    var msg = c2.messageList[message];
                                    UI.appendFieldTo(tplNewIt, msg, cnt_el)
                                }

                            }
                        }
                    }, function (e) {
                        layer.alert(e.msg);
                    });
                },
                t.find("a").click(function () {
                    queryIt();
                }).click(),
                $(".mx-top-select > h3").click(function () {
                    $(this).hasClass("on") ? ($(this).removeClass("on"),
                            $(this).next().hide()) : ($(this).addClass("on"),
                            $(this).next().show())
                }),
                $("#syzx").click(function () {
                    $('.xxx-layer').html(layer_html);

                    layer.open({
                        type: 1,
                        area: ["720px", "650px"],
                        title: "新建资讯信息",
                        content: $(".xxx-layer"),
                        skin: "mlayer",
                        success: function (e, t) {
                            var a = e.find("#publish-class-sel").empty(),
                                    artical_2 = e.find("#publish-class-sel2").empty(),
                                    s = e.find("#publish-author").val(""),
                                    i = e.find("#publish-title").val(""),
                                    n = e.find("#publish-content").val(""),
                                    l = e.find("#publish-file");

                            l.next("img").attr("src", "images/upfile.png"),

                                    l.on("change", function () {
                                        if ($(this).val()) {
                                            var data = {
                                                ckuid: sessionStorage.getItem("ckuid"),
                                                cksid: sessionStorage.getItem("cksid"),
                                                oldfile: "",
                                            };
                                            startLoading();
                                            uploadImg(data, '/addPicture', 'publish-file', 'cms-cover');
                                            stopLoading();

                                        }
                                    }),

                                    UI.renderHArtical_class1(a, function (i) {
                                        null !== $(this).val()
                                        &&
                                        UI.renderHArtical_class2(artical_2, $(this).val(), function (i) {
                                            null !== $(this).val()

                                        })
                                    });


                            $("#publish-frm-save").on('click', function (e) {

                                if (!artical_2.val()) {
                                    layer.msg("请选择二级分类");
                                    artical_2.focus();
                                }

                                if (!a.val()) {
                                    layer.msg("请选择一级分类");
                                    a.focus();
                                }
                                if (!i.val()) {
                                    layer.msg("请输入标题");
                                    i.focus();
                                }
                                if (!n.val()) {
                                    layer.msg("请输入内容");
                                    n.focus();
                                }
                                if (!s.val()) {
                                    layer.msg("请输入作者");
                                    s.focus();
                                }

                                API.service("/addMessage", {
                                    m_authorname: s.val(),
                                    m_class: a.val(),
                                    m_class2: artical_2.val(),
                                    m_content: n.val(),
                                    m_title: i.val(),
                                    m_type: "4",
                                    m_cover: $('#cms-cover').attr("src")
                                }, function (e) {
                                    layer.msg(e.msg), layer.close(t), queryIt();
                                });

                            }), $("#publish-frm-cancel").on('click', function (e) {
                                layer.close(t)
                            });


                        }, end: function () {
                            $(".layui-layer-shade").remove();
                        }
                    })
                }),
                $(".mx-checkbox").click(function (i) {
                    $(this).toggleClass("on")
                }),
                $(".sblb >h3").click(function () {
                    $(this).next().toggle();
                });

        var c1 = $('#class1')
        var c2 = $('#class2')

        UI.renderHArtical_class1(c1, function (i) {
            var c_rid = $(this).val();
            if (null !== c_rid) {
                UI.renderHArtical_class2(c2, $(this).val(), function (i) {
                    var c_id = $(this).val();

                })
            }
        });

        $('#class-seach').on('click', function () {
            queryIt($(c1).val(), $(c2).val())

        });


    })
    ;


</script>
</body>
</html>