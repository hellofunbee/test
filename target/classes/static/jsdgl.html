<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>物联网-综合信息-监视点管理</title>
  <link rel="stylesheet" href="css/reset.min.css">
  <link rel="stylesheet" href="css/zTreeStyle/zTreeStyle.css">
  <link rel="stylesheet" href="css/style.css">

</head>

<body>
  <div class="mx-main" page="jsdgl">
    <div class="mx-handle clearfix">
      
      <div class="sblb fl">
        <h3>设备列表</h3>
        <div class="tree-cnt">
          <div class="tree-show">
            <ul id="jsdgl_tree" class="ztree"></ul>
          </div>
        </div>
      </div>
      
      <div class="sm-title fl" onclick="window.showMainContent('synthesize2.html');return false;">
        图片信息
      </div>
      
      <a href="#" onclick="return false;" class="btn fr btn-new-monitor">
       新建监视点
      </a>
      <a href="#" onclick="return false;" class="btn btn-red fr btn-delete-all">
       删除选中
      </a>

    </div>
    
    <div class="jsd-module clearfic mt20">

      
      <div class="jcd-video camera-area" id="divPlugin">

      </div>
      
      <div class="jcd-sjModule">
        <table class="mx-table6">
          <thead>
          <tr>
            <th class="tc">
              <div class="mx-checkbox full-checkbox"><em></em></div>
            </th>
            <th>编号</th>
            <th>监视点名称</th>
            <th>开始时间</th>
            <th>结束时间</th>
            <th>间隔</th>
            <th>周期</th>
            <th>状态</th>
            <th class="tc">操作</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>

          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td>监视点1</td>
            <td>10:34:00</td>
            <td>10:34:00</td>
            <td>5分钟</td>
            <td>1天</td>
            <td>成功</td>
            <td class="tc"><a href="" class="btn-sm">编辑</a><a href="" class="btn-sm">删除</a> </td>
          </tr>
          <tr>
            <td class="tc">
              <div class="mx-checkbox"><em></em></div>
            </td>
            <td>1</td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td><input type="text"></td>
            <td class="tc"><a href="" class="btn-sm btn-bc">保存</a><a href="" class="btn-sm">删除</a></td>
          </tr>
          </tbody>
        </table>
        <a id="page_end"></a>
      </div>
    </div>
  </div>


  

  
  <script type="text/javascript">
      if (!window.jQuery) {
          var html =
              '<script src="js/jquery.min.js"><\/script>\n' +
              '<script src="js/jquery.scrollTo.min.js"><\/script>\n' +
              '<script src="js/jquery.bgiframe-2.1.2.js"><\/script>\n' +
              '<script src="js/jquery.ztree.all.min.js"><\/script>\n' +
              '<script src="js/layer/laydate/laydate.js"><\/script>\n' +
              '<script src="js/layer/layer.js"><\/script>\n' +
              '<script src="js/slide.js"><\/script>\n' +
              '<script src="js/common.js"><\/script>\n' +
              '<script src="js/purl.js"><\/script>\n' +
              '<script src="js/api.js"><\/script>\n' +
              '<script src="js/ui.js"><\/script>';
          document.write(html);
      }
  </script>



  <script>
    var newDeviceMonitorTpl='<tr>'+
        '<td class="tc">\n' +
        '<div class="mx-checkbox"><em></em></div>\n' +
        '</td>\n' +
        '<td field="monitorId">1</td>\n' + //编号	监视点名称	开始时间	结束时间	间隔	周期	状态

        '<td><input type="text" name="monitorName"></td>\n' +
        '<td><input type="text" name="beginTime" id="monitor_edit_begin_time" placeholder="HH:mm:ss"></td>\n' +
        '<td><input type="text" name="endTime" id="monitor_edit_end_time"  placeholder="HH:mm:ss"></td>\n' +
        '<td><input type="text" name="rateSecond"></td>\n' +
        '<td><input type="text" name="cycleDay"></td>\n'
        +'<td  field="success"></td>\n' +
        '<td class="tc"><a href="" class="btn-sm btn-bc btn-save-one">保存</a>' +
        // '<a href="" class="btn-sm btn-delete-one">删除</a>' +
        '<a href=""  class="btn-sm btn-cancel-one" >取消</a> ' +
        '</td>'
    +'</tr>';

    var rowDeviceMonitorTpl='<tr>\n' +
        '<td class="tc">\n' +
        '<div class="mx-checkbox"><em></em></div>\n' +
        '</td>\n' +
        '<td field="monitorId">1</td>\n' +
        '<td field="monitorName">监视点1</td>\n' +
        '<td field="beginTime" >10:34:00</td>\n' +
        '<td field="endTime">10:34:00</td>\n' +
        '<td><span field="rateSecond"></span>分钟</td>\n' +
        '<td><span field="cycleDay"></span>天</td>\n' +
        '<td field="success" render="function(v){return v===1;}">成功</td>\n' +
        '<td class="tc"><a href="" class="btn-sm btn-edit-one">编辑</a>' +
        '<a href=""  class="btn-sm btn-delete-one" >删除</a> ' +
        '</td></tr>';
    var page=$('[page=jsdgl]');

    var tbl = page.find('.mx-table6');
    page.find('.full-checkbox').click(function () {
        var checked = $(this).toggleClass('on').hasClass('on');
        var chks = tbl.find('tbody').find('.mx-checkbox').removeClass('on');
        if (checked) {
            chks.addClass('on');
        }
    });
    $(".sblb>h3").click(function() {
      var ctEl = $(this).next();
        ctEl.toggle();
        if(ctEl.is(':visible')){
            if(!ctEl.attr('_init_if')&& $.fn.bgiframe){
                ctEl.attr('_init_if',true);
                ctEl.bgiframe({conditional:true});
            }
        }
    });

    $(".show-pic").slide({
      titCell: ".smallImg li",
      mainCell: ".bigImg",
      effect: "fold",
      autoPlay: true,
      delayTime: 200
    }); //小图左滚动切换
    $(".show-pic .smallScroll").slide({
      mainCell: "ul",
      delayTime: 100,
      vis: 5,
      effect: "left",
      autoPage: true,
      prevCell: ".sPrev",
      nextCell: ".sNext"
    });
    $(".jsd-list li").click(function() {
      $(this).addClass('on').siblings().removeClass('on');
    });

    $(function () {
        var lastSelectNode=null;
        var deleteOneMonitor=function(e){
           if(e){
               e.preventDefault();
           };
            var me = $(this);
            var data=me.data('data');
           // layer.msg('删除  ....'+JSON.stringify(data));
            //console.log(lastSelectNode.oriData);
            //"pointEntity":{"ip":"111.53.182.34","port":"52407","tp_id":"54"}
            //TODO:get camera的信息
            API.service('/deleteIPCPoint' ,
            {"id":data.id,"deviceId":data.deviceId,"pointEntity":{
                ip:lastSelectNode.oriData.ip
                ,port:lastSelectNode.oriData.port
                ,tp_id:lastSelectNode.oriData.tp_id
                }},function (d) {
                    me.parents('tr').fadeOut( function () {
                        me.remove();
                    });
                },function(d){
                    layer.alert(d.msg || '出错了', function (idx) {
                        layer.close(idx);
                        me.parents('tr').fadeOut( function () {
                            me.remove();
                        });
                    });
                });
            return false;
        };
        var showCamera=function(deviceId){
            UI.showCamera(deviceId,'.camera-area');
        };

        var isTimeStr=function(timeStr){
            if(timeStr.length!==8)return false;
            var fields=timeStr.split(':');
            if(fields.length!==3)return false;
            var tmp=parseInt(fields[0]);
            if(tmp<0||tmp>23)return false; //hour
            tmp=parseInt(fields[1]);
            if(tmp<0||tmp>59)return false; //mins
            tmp=parseInt(fields[2]);
            if(tmp<0||tmp>59)return false; //secs
            return true;
        };

        var renderEditRow = function (item, tr) {
            var tbody = $('<tbody></tbody>');
            UI.appendFieldTo(newDeviceMonitorTpl, item, tbody)
                .find('a.btn-delete-one').data('data', item).click(function (e) {
                e.preventDefault();
                var me = this;
                layer.confirm('确定删除监控点[' + item.monitorName + ']吗?', function (idx) {
                    layer.close(idx);
                    deleteOneMonitor.call(me, e);
                });
            });
            var newTR = tbody.find('>tr');
            tr.after(newTR).hide();
          //  HH:mm:ss

//时间选择器
            laydate.render({
                elem: '#monitor_edit_begin_time'
                ,type: 'time'
            });

            laydate.render({
                elem: '#monitor_edit_end_time'
                ,type: 'time'
            });

            newTR.find('a.btn-cancel-one').click(function (e) {
                e.preventDefault();
                newTR.remove();
                tbody.remove();
                tr.show();
                return false;
            }).end()
                .find('a.btn-save-one').click(function (e) {
                e.preventDefault();
                var beginTime=newTR.find('[name=beginTime]').val();
                var endTime=newTR.find('[name=endTime]').val();

                var cycleDay=newTR.find('[name=cycleDay]').val();
                var monitorName=newTR.find('[name=monitorName]').val();
                var monitorId=item.monitorId;//newTR.find('[name=monitorId]').val();
                var rateSecond=newTR.find('[name=rateSecond]').val();
                //validate
                if(!isTimeStr(beginTime)){
                    layer.msg('请输入正确的开始时间');
                    newTR.find('[name=beginTime]').select().focus();
                    return;
                }if(!isTimeStr(endTime)){
                    layer.msg('请输入正确的结束时间');
                    newTR.find('[name=endTime]').select().focus();
                    return;
                }
                if(!monitorName){
                    layer.msg('请输入正确的监控名称');
                    newTR.find('[name=monitorName]').select().focus();
                    return;
                }
                if(parseInt(rateSecond)<0){
                    layer.msg('请输入正确的间隔时间（分钟）');
                    newTR.find('[name=rateSecond]').select().focus();
                    return;
                }
                if(parseInt(cycleDay)<0){
                    layer.msg('请输入正确的周期（天）');
                    newTR.find('[name=cycleDay]').select().focus();
                    return;
                }
                API.service('/addIPCPoint', {
                        "id": item.id, "deviceId": item.deviceId, "pointEntity": {
                            ip: lastSelectNode.oriData.ip
                            , port: lastSelectNode.oriData.port
                            , tp_id: lastSelectNode.oriData.tp_id
                        }, "beginTime": beginTime,// "12:00:00",
                        "endTime": endTime,//"18:00:00",
                        "cycleDay": cycleDay,// "2",
                        "monitorName": monitorName,//"监视点3",
                        "monitorId": monitorId,//"3",
                        "rateSecond": rateSecond//"1"
                    }
                    , function (d) {
                        layer.msg(d.msg);
                        newTR.remove();
                        tbody.remove();
                        item['beginTime']=beginTime;
                        item['endTime']=endTime;
                        item['cycleDay']=cycleDay;
                        item['monitorName']=monitorName;
                        item['rateSecond']=rateSecond;
                        tr.find('field[beginTime]').text(beginTime);
                        tr.find('field[endTime]').text(endTime);
                        tr.find('field[cycleDay]').text(cycleDay);
                        tr.find('field[monitorName]').text(monitorName);
                        tr.find('field[rateSecond]').text(rateSecond);
                        tr.show();
                    }, function (d) {
                        layer.alert(d.msg);
                    });

                return false;
            });
            for(var n in item){
                newTR.find('[name="'+n+'"]').val(item[n]);
            }

        };
        var renderRowTo=function(item,list){
            UI.appendFieldTo(rowDeviceMonitorTpl, item, list)
                .find('a.btn-delete-one').data('data', item).click(function (e) {
                e.preventDefault();
                var me = this;
                layer.confirm('确定删除监控点[' + item.monitorName + ']吗?', function (idx) {
                    layer.close(idx);
                    deleteOneMonitor.call(me, e);
                });
            }).end().find('a.btn-edit-one').click(function(e){
                e.preventDefault();
                var oldData=$(this).parents('tr').find('a.btn-delete-one').data('data');
                renderEditRow(oldData,$(this).parents('tr'));
                return false;
            });
        };
        var maxNodeId = 0;
        var treeEl=$("#jsdgl_tree");
        var onNodeSelect = function (node) {
            maxNodeId = 0;
            if (node && lastSelectNode && lastSelectNode === node) return;
            if (!node) node = lastSelectNode;
            if (node && node.oriData && node.oriData['tp_type'] === 3) {
                if (node.children.length) {
                    //onNodeSelect(node.children[0]);
                    treeEl.data('z-tree').selectNode(node.children[0]);
                    onNodeSelect(node.children[0]);
                    return;
                }
            } else if (node && node.oriData && node.oriData['tp_type'] === 4) {

                lastSelectNode = node;treeEl.parents('.tree-cnt').hide();
                //监控点
                var name = node.oriData['tp_name'];
                var id = node.oriData['tp_id'];
                var deviceId = node.oriData['deviceId'];
                var parentNode = node.getParentNode();
                if (parentNode && parentNode.oriData) {
                    name = parentNode.oriData['tp_name'] + ' ' + name;
                }

                $('.sm-userInfo').text(name);
                showCamera(deviceId);
                API.service('/listIPCPoint', {
                    deviceId: deviceId,
                    id: id
                }, function (d) {
                    var list = $('.jcd-sjModule tbody').empty();
                    $(d.object).each(function (i) {
                        this.success = this.success === 1 ? '成功' : '失败';
                        maxNodeId = Math.max(maxNodeId, this.monitorId);
                        renderRowTo(this, list);
                    });
                    list.find('.mx-checkbox').click(function (event) {
                        $(this).toggleClass('on');
                    });
                    list.find('li:eq(0)').click();
                }, function (d) {
                    var list = $('.jcd-sjModule tbody').empty();
                    layer.msg( d.msg);
                });
            }
        };
        treeEl.on('z-tree-load', function () {
            UI.findFirstDeviceOnTree($(this).data('z-tree'), 3, onNodeSelect);
        });

        UI.renderPointTree("#jsdgl_tree", onNodeSelect)
        ;

        page.find('.btn-delete-all').click(function () {
            var chks = tbl.find('tbody').find('.mx-checkbox');
            if (chks.size() === 0) {
                layer.msg('请选择监控点.');
            } else {
                layer.confirm("确定删除选中的" + chks.size() + "个监控点吗?", function (c) {
                    layer.close(c);
                    //API.service('/deleteIPCPoint')//all
                    chks.each(function (idx) {
                        deleteOneMonitor.call($(this).parent('tr').find('.btn-delete-one'));
                    });
                    // onNodeSelect();

                })
            }
        });
        page.find('.btn-new-monitor').click(function (e) {
            e.preventDefault();
            var tr = tbl.find('tbody').find('tr.hidden.new');
            if (!tr.size())
                tr = $('<tr class="hidden new" style="display:none;"></tr>').appendTo(tbl.find('tbody'));
            if (tr.next().is('tr:visible')) {
                $.scrollTo('#page_end', 300);
                tr.animate({color: 'yellow'});
                return;
            }

            renderEditRow({id: maxNodeId + 1}, tr);
            $.scrollTo('#page_end', 300);
            return false;
        })
    })
  </script>

</body>

</html>
